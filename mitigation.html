<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mitigation — !(Not) Doomsday</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=Familjen+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@300;400;600;700&family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
/* ── RESET + SHARED NAV (matches other pages) ── */
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#07090D;color:#E8EDF5;font-family:'Familjen Grotesk','Outfit',sans-serif;min-height:100vh;}

/* ── NAVBAR (identical to globe/dashboard pages) ── */
.navbar{position:fixed;top:0;left:0;right:0;z-index:1000;display:flex;align-items:center;justify-content:space-between;padding:0 40px;height:60px;background:rgba(8,10,16,.75);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.04);}
.nav-logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:#f0f2f5;}
.logo-icon{width:32px;height:32px;background:linear-gradient(135deg,#ff4d2e,#ff8c42);border-radius:8px;display:flex;align-items:center;justify-content:center;}
.logo-text{font-family:'Outfit',sans-serif;font-size:16px;font-weight:700;letter-spacing:-0.5px;}
.logo-text span{color:#ff6840;}
.nav-links{display:flex;gap:32px;list-style:none;}
.nav-links a{color:rgba(255,255,255,.45);text-decoration:none;font-size:13px;font-weight:500;letter-spacing:.5px;transition:color .2s;}
.nav-links a:hover,.nav-links a.active{color:#fff;}
.nav-info{width:32px;height:32px;border-radius:50%;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:rgba(255,255,255,.4);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;}
.nav-info:hover{background:rgba(255,255,255,.08);color:#fff;}

/* ── ABOUT MODAL ── */
.about-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(8px);z-index:2000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
.about-overlay.visible{opacity:1;pointer-events:all;}
.about-modal{background:rgba(16,19,28,.95);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:40px;max-width:480px;width:90%;box-shadow:0 24px 80px rgba(0,0,0,.6);position:relative;}
.about-close{position:absolute;top:16px;right:16px;width:28px;height:28px;border-radius:50%;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:rgba(255,255,255,.5);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.about-close:hover{background:rgba(255,255,255,.1);color:#fff;}
.about-title{font-family:'Outfit',sans-serif;font-size:22px;font-weight:700;letter-spacing:-0.5px;margin-bottom:4px;}
.about-title span{color:#ff6840;}
.about-subtitle{font-size:12px;color:rgba(255,255,255,.35);letter-spacing:0.5px;margin-bottom:16px;}
.about-desc{font-size:13px;line-height:1.7;color:rgba(255,255,255,.5);margin-bottom:20px;}
.about-team-label{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:2px;color:#ff6840;margin-bottom:10px;font-weight:600;}
.about-team{display:flex;flex-direction:column;gap:6px;}
.about-member{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.04);}
.about-name{font-size:13px;font-weight:600;color:rgba(255,255,255,.8);}
.about-email{font-family:'JetBrains Mono',monospace;font-size:10px;color:rgba(255,255,255,.3);}

/* ── MITIGATION PAGE LAYOUT ── */
.miti-page{padding-top:60px;min-height:100vh;}

/* ── ORIGINAL MITIGATION STYLES (from teammate's index.html) ── */
:root{
  --bg-0:#07090D;--bg-1:#0C1018;--bg-2:#111822;--bg-3:#18212E;
  --border:#1E2A3A;--border-glow:#2A3A50;
  --text-0:#E8EDF5;--text-1:#A0ADBF;--text-2:#5E6E82;
  --red:#FF4757;--red-dim:rgba(255,71,87,.12);
  --orange:#FF8C42;--orange-dim:rgba(255,140,66,.12);
  --green:#26DE81;--green-dim:rgba(38,222,129,.12);
  --cyan:#45D1E6;--cyan-dim:rgba(69,209,230,.1);
  --yellow:#FFD32A;--yellow-dim:rgba(255,211,42,.1);
  --purple:#A55EEA;--purple-dim:rgba(165,94,234,.1);
  --blue:#4B7BEC;--blue-dim:rgba(75,123,236,.12);
  --emergency:#FF6348;--emergency-dim:rgba(255,99,72,.15);
}

/* ── TOPBAR (mitigation-specific) ── */
.topbar{height:52px;background:var(--bg-1);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:16px;}
.topbar-logo{display:flex;align-items:center;gap:9px;font-weight:700;font-size:14px;letter-spacing:-.3px;}
.topbar-logo .icon{width:26px;height:26px;background:linear-gradient(135deg,var(--red),var(--orange));border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;}
.topbar-status{margin-left:auto;display:flex;align-items:center;gap:7px;font-size:11px;color:var(--text-2);font-family:'IBM Plex Mono',monospace;}
.status-dot{width:7px;height:7px;border-radius:50%;background:var(--text-2);}
.status-dot.ok{background:var(--green);box-shadow:0 0 8px var(--green);}
.status-dot.loading{background:var(--yellow);animation:pulse .9s infinite;}
.status-dot.error{background:var(--red);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.25}}

/* ── LOADING BAR ── */
.load-bar{height:3px;background:var(--bg-2);position:relative;overflow:hidden;display:none;}
.load-bar.on{display:block;}
.load-bar::after{content:'';position:absolute;top:0;left:-40%;width:40%;height:100%;background:linear-gradient(90deg,transparent,var(--orange),transparent);animation:lslide 1.1s ease infinite;}
@keyframes lslide{0%{left:-40%}100%{left:100%}}

/* ── STATS BAR ── */
.stats-bar{display:none;gap:12px;flex-wrap:wrap;padding:14px 24px;background:var(--bg-1);border-bottom:1px solid var(--border);}
.stats-bar.on{display:flex;}
.scard{flex:1;min-width:110px;padding:10px 14px;background:var(--bg-0);border:1px solid var(--border);border-radius:7px;}
.scard .sl{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--text-2);font-weight:600;margin-bottom:3px;}
.scard .sv{font-family:'IBM Plex Mono',monospace;font-size:18px;font-weight:700;}
.scard .ss{font-family:'IBM Plex Mono',monospace;font-size:10px;margin-top:1px;}
.c-g{color:var(--green)}.c-r{color:var(--red)}.c-c{color:var(--cyan)}.c-y{color:var(--yellow)}.c-o{color:var(--orange)}.c-p{color:var(--purple)}.c-d{color:var(--text-2)}

/* ── GRAPH ── */
.graph-row{display:none;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border);height:520px;}
.graph-cell{position:relative;overflow:hidden;}
.graph-cell+.graph-cell{border-left:1px solid var(--border);}
.graph-cell canvas{display:block;cursor:grab;}.graph-cell canvas:active{cursor:grabbing;}
.graph-label{position:absolute;top:12px;left:16px;display:flex;align-items:center;gap:8px;z-index:5;pointer-events:none;}
.graph-label .gl-dot{width:9px;height:9px;border-radius:3px;}
.graph-label .gl-text{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;text-shadow:0 1px 6px rgba(0,0,0,.7);}
.graph-label .gl-badge{font-family:'IBM Plex Mono',monospace;font-size:10px;padding:2px 8px;border-radius:5px;font-weight:600;}
.graph-zoom{position:absolute;bottom:12px;right:12px;display:flex;flex-direction:column;gap:3px;z-index:5;}
.gz-btn{width:30px;height:30px;background:var(--bg-1);border:1px solid var(--border);border-radius:6px;color:var(--text-1);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s;}
.gz-btn:hover{background:var(--bg-3);color:var(--text-0);}
.graph-tooltip{position:fixed;padding:9px 13px;background:rgba(12,16,24,.94);border:1px solid var(--border);border-radius:7px;font-size:11px;pointer-events:none;opacity:0;transition:opacity .12s;z-index:200;backdrop-filter:blur(6px);max-width:210px;}
.graph-tooltip.vis{opacity:1;}
.graph-tooltip .tt-n{font-weight:700;font-size:12px;color:var(--text-0);margin-bottom:2px;}
.graph-tooltip .tt-t{font-size:9px;text-transform:uppercase;letter-spacing:.7px;margin-bottom:4px;}
.graph-tooltip .tt-s{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--text-2);}

/* ── LEGEND ── */
.legend-bar{display:none;gap:14px;flex-wrap:wrap;padding:10px 24px;background:var(--bg-1);border-bottom:1px solid var(--border);align-items:center;}
.legend-bar.on{display:flex;}
.leg-title{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--text-2);font-weight:600;margin-right:4px;}
.leg-item{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--text-1);font-family:'IBM Plex Mono',monospace;}
.leg-item .ld{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.leg-item .le{width:20px;height:0;border-top:2px solid;flex-shrink:0;}

/* ── TABS ── */
.tab-row{display:none;background:var(--bg-1);border-bottom:1px solid var(--border);padding:0 24px;}
.tab-row.on{display:flex;}
.tab-btn{padding:12px 20px;font-size:12px;font-weight:600;color:var(--text-2);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all .15s;font-family:'Familjen Grotesk',sans-serif;}
.tab-btn:hover{color:var(--text-1);}.tab-btn.active{color:var(--cyan);border-bottom-color:var(--cyan);}
.tab-body{display:none;padding:20px 24px;}.tab-body.active{display:block;}

/* ── ADJACENCY ── */
.adj-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;}
.adj-col h3{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-2);margin-bottom:12px;font-weight:600;display:flex;align-items:center;gap:8px;}
.adj-search{padding:7px 11px;background:var(--bg-0);border:1px solid var(--border);border-radius:5px;color:var(--text-0);font-family:'IBM Plex Mono',monospace;font-size:11px;outline:none;width:100%;margin-bottom:10px;}.adj-search:focus{border-color:var(--cyan);}
.anode{margin-bottom:8px;border:1px solid var(--border);border-radius:6px;overflow:hidden;}
.anode-h{display:flex;align-items:center;gap:7px;padding:8px 12px;background:var(--bg-2);cursor:pointer;user-select:none;transition:background .12s;}
.anode-h:hover{background:var(--bg-3);}
.anode-h .nd{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.anode-h .nn{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:600;}
.anode-h .nc{margin-left:auto;font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--text-2);}
.anode-h .chev{color:var(--text-2);font-size:9px;transition:transform .15s;}
.anode.open .chev{transform:rotate(90deg);}
.anb{display:none;border-top:1px solid var(--border);}.anode.open .anb{display:block;}
.anb-r{display:flex;align-items:center;gap:6px;padding:5px 12px 5px 24px;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--text-1);border-bottom:1px solid rgba(30,42,58,.4);}
.anb-r:last-child{border-bottom:none;}
.anb-r .rnd{width:4px;height:4px;border-radius:50%;flex-shrink:0;}
.anb-r .retype{font-size:8px;padding:1px 6px;border-radius:3px;font-weight:600;text-transform:uppercase;letter-spacing:.4px;}
.anb-r .rdist{margin-left:auto;color:var(--text-2);font-size:9px;}
.et-road{background:rgba(94,110,130,.2);color:var(--text-2);}
.et-power{background:var(--yellow-dim);color:var(--yellow);}
.et-water{background:var(--cyan-dim);color:var(--cyan);}
.et-emergency{background:var(--red-dim);color:var(--red);}

/* ── CHANGES ── */
.changes-list{display:flex;flex-direction:column;gap:8px;}
.ccard{padding:11px 14px;background:var(--bg-1);border:1px solid var(--border);border-radius:7px;}
.ccard:hover{border-color:var(--border-glow);}
.ccard .cr{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:600;color:var(--text-0);margin-bottom:4px;display:flex;align-items:center;gap:6px;}
.ccard .ct{font-size:8px;padding:1px 6px;border-radius:3px;font-weight:600;text-transform:uppercase;display:inline-block;margin-bottom:4px;}
.ccard .cm{font-size:11px;color:var(--text-1);line-height:1.5;}
.phase-calamity{border-left:3px solid var(--red);}
.phase-llm_optimization{border-left:3px solid var(--green);}
.phase-programmatic_pruning{border-left:3px solid var(--orange);}

/* ── TOAST ── */
.toast-container{position:fixed;top:124px;right:20px;z-index:999;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.toast{padding:14px 20px;border-radius:8px;font-size:12px;line-height:1.5;max-width:420px;pointer-events:all;animation:toastIn .3s ease,toastOut .4s ease 5s forwards;display:flex;align-items:flex-start;gap:10px;box-shadow:0 8px 32px rgba(0,0,0,.5);}
.toast .t-icon{font-size:16px;flex-shrink:0;margin-top:1px;}
.toast .t-body{flex:1;}
.toast .t-title{font-weight:700;margin-bottom:2px;}
.toast .t-msg{color:inherit;opacity:.85;}
.toast .t-close{cursor:pointer;opacity:.5;font-size:16px;flex-shrink:0;margin-left:8px;}.toast .t-close:hover{opacity:1;}
.toast-error{background:rgba(255,71,87,.15);border:1px solid rgba(255,71,87,.3);color:var(--red);}
.toast-ok{background:rgba(38,222,129,.12);border:1px solid rgba(38,222,129,.25);color:var(--green);}
.toast-warn{background:rgba(255,211,42,.12);border:1px solid rgba(255,211,42,.25);color:var(--yellow);}
@keyframes toastIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{from{opacity:1}to{opacity:0;transform:translateY(-10px);pointer-events:none;}}

/* ── EMPTY STATE ── */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 24px;text-align:center;gap:16px;}
.empty-state .es-icon{font-size:48px;opacity:.5;}
.empty-state .es-title{font-size:18px;font-weight:700;color:var(--text-0);}
.empty-state .es-desc{font-size:13px;color:var(--text-2);max-width:440px;line-height:1.6;}
.empty-state .es-btn{margin-top:8px;padding:10px 24px;background:linear-gradient(135deg,var(--red),var(--orange));border:none;border-radius:8px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;transition:transform .15s,box-shadow .15s;}
.empty-state .es-btn:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(255,71,87,.3);}
.empty-state .es-btn:disabled{opacity:.5;cursor:wait;}

::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:var(--bg-0);}::-webkit-scrollbar-thumb{background:var(--bg-3);border-radius:3px;}
@media(max-width:900px){.graph-row,.adj-grid{grid-template-columns:1fr;}.graph-cell{height:400px;}}
</style>
</head>
<body>

<!-- ============================================================
     SHARED NAVIGATION
     ============================================================ -->
<nav class="navbar">
  <a href="index.html" class="nav-logo">
    <div class="logo-icon">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/>
        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
      </svg>
    </div>
    <div class="logo-text">!(<span>Not</span>)Doomsday</div>
  </a>
  <ul class="nav-links">
    <li><a href="globe.html">Globe</a></li>
    <li><a href="dashboard.html">Dashboard</a></li>
    <li><a href="mitigation.html" class="active">Mitigation</a></li>
  </ul>
  <button class="nav-info" title="About the project">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
    </svg>
  </button>
</nav>

<!-- ============================================================
     MITIGATION PAGE CONTENT
     ============================================================ -->
<div class="miti-page">
  <div class="topbar">
    <div class="topbar-logo"><div class="icon">&#9889;</div>Infrastructure Mitigation</div>
    <div class="topbar-status"><span class="status-dot" id="sDot"></span><span id="sTxt">Initializing...</span></div>
  </div>
  <div class="load-bar" id="loadBar"></div>

  <!-- Empty state (shown when no data is available yet) -->
  <div class="empty-state" id="emptyState">
    <div class="es-icon">&#128507;</div>
    <div class="es-title">No Analysis Data Yet</div>
    <div class="es-desc">
      Run the threat analysis pipeline for a city first. This will generate the
      apocalypse analysis that the mitigation engine needs to optimize infrastructure.
    </div>
    <button class="es-btn" id="runPipelineBtn" onclick="runPipeline()">Run Pipeline for Boston</button>
  </div>

  <div class="stats-bar" id="statsBar"></div>

  <div class="graph-row" id="graphRow">
    <div class="graph-cell" id="cellOrig">
      <div class="graph-label"><div class="gl-dot" style="background:var(--blue)"></div><span class="gl-text" style="color:var(--blue)">Original Network</span><span class="gl-badge" id="glbO" style="background:var(--blue-dim);color:var(--blue)"></span></div>
      <canvas id="cvO"></canvas>
      <div class="graph-zoom"><button class="gz-btn" onclick="zG('O',1.3)">+</button><button class="gz-btn" onclick="zG('O',1/1.3)">&minus;</button><button class="gz-btn" onclick="rG('O')" style="font-size:11px">&#10226;</button></div>
    </div>
    <div class="graph-cell" id="cellOpt">
      <div class="graph-label"><div class="gl-dot" style="background:var(--green)"></div><span class="gl-text" style="color:var(--green)">Mitigated Network</span><span class="gl-badge" id="glbP" style="background:var(--green-dim);color:var(--green)"></span></div>
      <canvas id="cvP"></canvas>
      <div class="graph-zoom"><button class="gz-btn" onclick="zG('P',1.3)">+</button><button class="gz-btn" onclick="zG('P',1/1.3)">&minus;</button><button class="gz-btn" onclick="rG('P')" style="font-size:11px">&#10226;</button></div>
    </div>
  </div>

  <div class="legend-bar" id="legendBar"></div>
  <div class="tab-row" id="tabRow">
    <button class="tab-btn active" onclick="sTab('adj',this)">Adjacency Lists</button>
    <button class="tab-btn" onclick="sTab('chg',this)">Changes</button>
    <button class="tab-btn" onclick="sTab('rea',this)">LLM Reasoning</button>
    <button class="tab-btn" onclick="sTab('jsn',this)">Raw JSON</button>
  </div>
  <div class="tab-body active" id="tab-adj"></div>
  <div class="tab-body" id="tab-chg"></div>
  <div class="tab-body" id="tab-rea"></div>
  <div class="tab-body" id="tab-jsn"></div>
  <div class="graph-tooltip" id="tooltip"></div>
  <div class="toast-container" id="toasts"></div>
</div>

<!-- ============================================================
     ABOUT MODAL
     ============================================================ -->
<div class="about-overlay" id="about-overlay">
  <div class="about-modal">
    <button class="about-close" id="about-close">&times;</button>
    <div class="about-title">!(<span>Not</span>)Doomsday</div>
    <div class="about-subtitle">AI-Powered Multi-Hazard Catastrophic Risk Monitor</div>
    <p class="about-desc">
      Built for the InnovAIte Hackathon 2026 at Northeastern University.
      Aggregates real-time data from USGS, NASA, NOAA, WHO, and other authoritative
      sources across six threat domains, then uses a Groq-powered LLM cascade engine
      to predict how disasters compound in real time.
    </p>
    <div class="about-team-label">TEAM 20</div>
    <div class="about-team">
      <div class="about-member"><span class="about-name">Atharva Keskar</span><span class="about-email">keskar.at@northeastern.edu</span></div>
      <div class="about-member"><span class="about-name">Soham Santra</span><span class="about-email">santra.s@northeastern.edu</span></div>
      <div class="about-member"><span class="about-name">Vedant Ranade</span><span class="about-email">ranade.v@northeastern.edu</span></div>
      <div class="about-member"><span class="about-name">Vashistha Pandya</span><span class="about-email">pandya.vas@northeastern.edu</span></div>
      <div class="about-member"><span class="about-name">Viraj Paradkar</span><span class="about-email">paradkar.v@northeastern.edu</span></div>
    </div>
  </div>
</div>

<script>
/* ═══════════════════════════════════════════════════════════
   ABOUT MODAL
   ═══════════════════════════════════════════════════════════ */
document.querySelector('.nav-info').addEventListener('click', () => {
  document.getElementById('about-overlay').classList.add('visible')
})
document.getElementById('about-close').addEventListener('click', () => {
  document.getElementById('about-overlay').classList.remove('visible')
})
document.getElementById('about-overlay').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) document.getElementById('about-overlay').classList.remove('visible')
})

/* ═══════════════════════════════════════════════════════════
   HELPERS
   ═══════════════════════════════════════════════════════════ */
const $ = id => document.getElementById(id);
function esc(s){ return s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }

const NC = {
  'Hospital':'#E63946','Fire Station':'#FF6B35','Police Station':'#1D3557',
  'Ambulance Depot':'#E07A5F','Bunker/Shelter':'#6D6875','Evacuation Point':'#B5838D',
  'Food Service':'#2A9D8F','Grocery Store':'#57CC99','Water Supply':'#48CAE4',
  'Power Plant':'#FFBE0B','Substation':'#F4A261','Telecom Tower':'#7209B7',
  'Water Treatment':'#0096C7'
};
const NS = {
  'Hospital':'square','Fire Station':'triangle','Police Station':'diamond',
  'Ambulance Depot':'triangle-down','Bunker/Shelter':'octagon','Evacuation Point':'pentagon',
  'Food Service':'circle','Grocery Store':'circle','Water Supply':'hexagon',
  'Power Plant':'star','Substation':'diamond','Telecom Tower':'triangle',
  'Water Treatment':'hexagon'
};
const NZ = {
  'Hospital':11,'Fire Station':10,'Police Station':10,'Ambulance Depot':9,
  'Bunker/Shelter':10,'Evacuation Point':9,'Food Service':8,'Grocery Store':7,
  'Water Supply':9,'Power Plant':14,'Substation':9,'Telecom Tower':10,'Water Treatment':12
};
const EC = {
  road:      {c:'#3D444D',w:.6,d:[],a:.2},
  power:     {c:'#FFD32A',w:1.6,d:[8,4],a:.4},
  water:     {c:'#45D1E6',w:1.4,d:[6,3,2,3],a:.4},
  emergency: {c:'#FF4757',w:1.1,d:[3,3],a:.35},
};
const EL = {road:'Road',power:'Power',water:'Water',emergency:'Emergency'};

function nC(l){ for(const[t,c] of Object.entries(NC)) if(l.startsWith(t)) return c; return '#5E6E82'; }
function nT(l){ for(const t of Object.keys(NC)) if(l.startsWith(t)) return t; return ''; }

function sS(s,t){ $('sDot').className='status-dot '+s; $('sTxt').textContent=t; }

function toast(type,title,msg,duration=6000){
  const c=$('toasts'),icons={error:'✕',ok:'✓',warn:'⚠'};
  const t=document.createElement('div');
  t.className='toast toast-'+type;
  t.innerHTML=`<span class="t-icon">${icons[type]||'ℹ'}</span><div class="t-body"><div class="t-title">${title}</div><div class="t-msg">${msg}</div></div><span class="t-close" onclick="this.parentElement.remove()">&times;</span>`;
  c.appendChild(t);
  setTimeout(()=>{if(t.parentElement)t.remove();},duration);
}

/* ═══════════════════════════════════════════════════════════
   GRAPH ENGINE
   ═══════════════════════════════════════════════════════════ */
const G = {
  O:{cam:{x:0,y:0,z:1},nodes:[],edges:[],hov:null,dr:false,ds:{},cs:{},cityR:0,cityName:''},
  P:{cam:{x:0,y:0,z:1},nodes:[],edges:[],hov:null,dr:false,ds:{},cs:{},cityR:0,cityName:''},
};

function buildGD(pos, adj){
  if(!pos||!adj) return {nodes:[],edges:[]};
  const nodes=[], edges=[], idx={};
  let i=0;
  for(const[label,p] of Object.entries(pos)){
    const t = p.type || nT(label);
    nodes.push({id:i, label, x:p.x, y:p.y, type:t, color:NC[t]||'#5E6E82', shape:NS[t]||'circle', size:NZ[t]||8, deg:0});
    idx[label]=i; i++;
  }
  const seen = new Set();
  for(const[label,nbs] of Object.entries(adj)){
    const fi = idx[label]; if(fi===undefined) continue;
    for(const nb of nbs){
      const ti = idx[nb.neighbor]; if(ti===undefined) continue;
      const k = Math.min(fi,ti)+'-'+Math.max(fi,ti)+'-'+nb.edge_type;
      if(seen.has(k)) continue; seen.add(k);
      edges.push({from:fi, to:ti, type:nb.edge_type, dist:nb.distance});
      nodes[fi].deg++; nodes[ti].deg++;
    }
  }
  return {nodes, edges};
}

function w2s(cam,wx,wy,cw,ch){ return {x:(wx-cam.x)*cam.z+cw/2, y:(wy-cam.y)*cam.z+ch/2}; }
function s2w(cam,sx,sy,cw,ch){ return {x:(sx-cw/2)/cam.z+cam.x, y:(sy-ch/2)/cam.z+cam.y}; }

function drawSh(ctx,sh,x,y,s,col,hv){
  ctx.fillStyle=col; ctx.strokeStyle=hv?'#F0F6FC':'rgba(255,255,255,.25)'; ctx.lineWidth=hv?2.5:1; ctx.beginPath();
  switch(sh){
    case'circle':ctx.arc(x,y,s,0,Math.PI*2);break;
    case'square':ctx.rect(x-s,y-s,s*2,s*2);break;
    case'diamond':ctx.moveTo(x,y-s*1.2);ctx.lineTo(x+s,y);ctx.lineTo(x,y+s*1.2);ctx.lineTo(x-s,y);ctx.closePath();break;
    case'triangle':ctx.moveTo(x,y-s*1.2);ctx.lineTo(x+s,y+s*.7);ctx.lineTo(x-s,y+s*.7);ctx.closePath();break;
    case'triangle-down':ctx.moveTo(x,y+s*1.2);ctx.lineTo(x+s,y-s*.7);ctx.lineTo(x-s,y-s*.7);ctx.closePath();break;
    case'hexagon':for(let i=0;i<6;i++){const a=Math.PI/3*i-Math.PI/6;ctx[i?'lineTo':'moveTo'](x+s*Math.cos(a),y+s*Math.sin(a));}ctx.closePath();break;
    case'octagon':for(let i=0;i<8;i++){const a=Math.PI/4*i-Math.PI/8;ctx[i?'lineTo':'moveTo'](x+s*Math.cos(a),y+s*Math.sin(a));}ctx.closePath();break;
    case'pentagon':for(let i=0;i<5;i++){const a=Math.PI*2/5*i-Math.PI/2;ctx[i?'lineTo':'moveTo'](x+s*Math.cos(a),y+s*Math.sin(a));}ctx.closePath();break;
    case'star':for(let i=0;i<10;i++){const a=Math.PI/5*i-Math.PI/2;const r=i%2===0?s*1.3:s*.55;ctx[i?'lineTo':'moveTo'](x+r*Math.cos(a),y+r*Math.sin(a));}ctx.closePath();break;
  }
  if(hv){ctx.save();ctx.shadowColor=col;ctx.shadowBlur=Math.min(18,s*1.5);ctx.fill();ctx.restore();}
  ctx.fill();ctx.stroke();
}

function rdr(k){
  const g=G[k], cv=$('cv'+k); if(!cv)return;
  const ctx=cv.getContext('2d'), w=cv.width, h=cv.height;
  ctx.clearRect(0,0,w,h); ctx.fillStyle='#07090D'; ctx.fillRect(0,0,w,h);

  ctx.strokeStyle='rgba(30,42,58,.3)'; ctx.lineWidth=.5;
  const gs=50*g.cam.z, ox=(w/2-g.cam.x*g.cam.z)%gs, oy=(h/2-g.cam.y*g.cam.z)%gs;
  for(let x=ox;x<w;x+=gs){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}
  for(let y=oy;y<h;y+=gs){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}

  if(g.cityR>0){
    const ctr=w2s(g.cam,0,0,w,h), rPx=g.cityR*g.cam.z;
    for(const frac of[0.33,0.66]){
      ctx.beginPath();ctx.arc(ctr.x,ctr.y,rPx*frac,0,Math.PI*2);
      ctx.fillStyle='rgba(22,27,34,'+(0.08*(1-frac))+')';ctx.fill();
      ctx.strokeStyle='rgba(30,42,58,.2)';ctx.lineWidth=1;ctx.setLineDash([]);ctx.stroke();
    }
    ctx.beginPath();ctx.arc(ctr.x,ctr.y,rPx*1.1,0,Math.PI*2);
    ctx.strokeStyle='rgba(42,58,80,.5)';ctx.lineWidth=1.5;ctx.setLineDash([8,5]);ctx.stroke();ctx.setLineDash([]);
    if(g.cityName){
      ctx.font=`600 ${Math.min(Math.max(10,11*g.cam.z),14)}px 'IBM Plex Mono',monospace`;
      ctx.fillStyle='rgba(94,110,130,.5)';ctx.textAlign='center';
      ctx.fillText(g.cityName.toUpperCase()+' CITY BOUNDARY',ctr.x,ctr.y-rPx*1.1-8);
    }
    ctx.font=`${Math.min(Math.max(8,9*g.cam.z),11)}px 'IBM Plex Mono',monospace`;
    ctx.fillStyle='rgba(94,110,130,.22)';ctx.textAlign='center';
    ctx.fillText('DOWNTOWN',ctr.x,ctr.y+rPx*0.15);
    ctx.fillText('URBAN',ctr.x,ctr.y+rPx*0.5);
    ctx.fillText('SUBURBS',ctr.x,ctr.y+rPx*0.88);
  }

  for(const etype of['road','water','power','emergency']){
    const cfg=EC[etype]; if(!cfg) continue;
    for(const e of g.edges){
      if(e.type!==etype) continue;
      const a=w2s(g.cam,g.nodes[e.from].x,g.nodes[e.from].y,w,h);
      const b=w2s(g.cam,g.nodes[e.to].x,g.nodes[e.to].y,w,h);
      ctx.strokeStyle=cfg.c; ctx.lineWidth=Math.min(cfg.w*g.cam.z,4); ctx.globalAlpha=cfg.a;
      ctx.setLineDash(cfg.d.length?cfg.d.map(d=>Math.min(d*g.cam.z,16)):[]);
      ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.stroke();
    }
  }
  ctx.globalAlpha=1; ctx.setLineDash([]);

  // Scale node cap based on density — dense OSM graphs need smaller nodes
  const nodeCount = g.nodes.length;
  const maxNodePx = nodeCount > 60 ? 10 : nodeCount > 40 ? 14 : nodeCount > 20 ? 18 : 24;

  for(const n of g.nodes){
    const p=w2s(g.cam,n.x,n.y,w,h), rawS=n.size*g.cam.z, s=Math.min(rawS,maxNodePx);
    const hv=g.hov&&g.hov.id===n.id;
    const glowR=Math.min(s*2,30);
    const grad=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,glowR);
    grad.addColorStop(0,n.color+'18');grad.addColorStop(1,n.color+'00');
    ctx.fillStyle=grad;ctx.beginPath();ctx.arc(p.x,p.y,glowR,0,Math.PI*2);ctx.fill();
    drawSh(ctx,n.shape,p.x,p.y,s,n.color,hv);
    const labelMaxPx = nodeCount > 60 ? 10 : 13;
    if(g.cam.z>.4){
      ctx.font=`${Math.min(Math.max(7,8*g.cam.z),labelMaxPx)}px 'IBM Plex Mono',monospace`;
      ctx.fillStyle=n.color+'99';ctx.textAlign='left';ctx.fillText(n.label,p.x+s+3,p.y+3);
    }
  }
}

function initCv(k){
  const cell=$('cell'+(k==='O'?'Orig':'Opt')), cv=$('cv'+k), g=G[k];
  function rs(){cv.width=cell.clientWidth;cv.height=cell.clientHeight;rdr(k);}
  window.addEventListener('resize',rs); rs();

  cv.addEventListener('mousedown',e=>{g.dr=true;g.ds={x:e.clientX,y:e.clientY};g.cs={x:g.cam.x,y:g.cam.y};});
  window.addEventListener('mousemove',e=>{
    if(g.dr){g.cam.x=g.cs.x-(e.clientX-g.ds.x)/g.cam.z;g.cam.y=g.cs.y-(e.clientY-g.ds.y)/g.cam.z;rdr(k);}
    const rect=cv.getBoundingClientRect(), mx=e.clientX-rect.left, my=e.clientY-rect.top;
    if(mx<0||my<0||mx>cv.width||my>cv.height){if(g.hov){g.hov=null;rdr(k);$('tooltip').classList.remove('vis');}return;}
    const wld=s2w(g.cam,mx,my,cv.width,cv.height);
    let cl=null, cd=Infinity;
    for(const n of g.nodes){const d=Math.hypot(n.x-wld.x,n.y-wld.y);const th=Math.min(n.size,14)*1.5/g.cam.z;if(d<th&&d<cd){cl=n;cd=d;}}
    if(cl!==g.hov){g.hov=cl;rdr(k);}
    const tt=$('tooltip');
    if(g.hov){
      tt.innerHTML=`<div class="tt-n">${g.hov.label}</div><div class="tt-t" style="color:${g.hov.color}">${g.hov.type}</div><div class="tt-s">Connections: ${g.hov.deg}</div>`;
      tt.style.left=(e.clientX+14)+'px';tt.style.top=(e.clientY-8)+'px';tt.classList.add('vis');
    }else{tt.classList.remove('vis');}
  });
  window.addEventListener('mouseup',()=>{g.dr=false;});
  cv.addEventListener('wheel',e=>{e.preventDefault();g.cam.z=Math.max(.1,Math.min(4,g.cam.z*(e.deltaY>0?.9:1.1)));rdr(k);},{passive:false});
}

function zG(k,f){G[k].cam.z=Math.max(.1,Math.min(4,G[k].cam.z*f));rdr(k);}
function rG(k){G[k].cam={x:0,y:0,z:1};rdr(k);}

/* ═══════════════════════════════════════════════════════════
   RENDER ALL DATA
   ═══════════════════════════════════════════════════════════ */
function renderAll(d){
  $('emptyState').style.display = 'none';

  const pos = d.node_positions || {};
  const origAdj = d.original_adjacency_list || {};
  const mitAdj = d.mitigated_adjacency_list || {};
  const origStats = d.original_stats || {};
  const mitStats = d.mitigated_stats || {};
  const changes = d.changes || [];
  const city = d.city || {};
  const cityR = city.radius_km || 0;

  const scaledPos = {};
  for(const[label,p] of Object.entries(pos)){
    scaledPos[label] = { x: p.x * 50, y: p.y * 50, type: p.type };
  }

  const origEdges = origStats.total_edges || 0;
  const mitEdges = mitStats.total_edges || 0;
  const edgeDiff = mitEdges - origEdges;
  const sgn = edgeDiff >= 0 ? '+' : '';
  const origNodes = origStats.infrastructure_nodes || 0;
  const mitNodes = mitStats.infrastructure_nodes || 0;
  const nodeDiff = mitNodes - origNodes;
  const nsgn = nodeDiff >= 0 ? '+' : '';

  const b = $('statsBar');
  b.classList.add('on');
  b.innerHTML = `
    <div class="scard"><div class="sl">City</div><div class="sv" style="font-size:15px;color:var(--text-0)">${city.name||'?'}</div><div class="ss c-d">${d.data_source||'?'}</div></div>
    <div class="scard"><div class="sl">LLM Model</div><div class="sv" style="font-size:11px;color:var(--cyan)">${d.groq_analysis?.model_used||'—'}</div></div>
    <div class="scard"><div class="sl">Nodes</div><div class="sv c-c">${origNodes}</div><div class="ss ${nodeDiff<0?'c-r':'c-d'}">${nsgn}${nodeDiff} after</div></div>
    <div class="scard"><div class="sl">Edges</div><div class="sv c-p">${origEdges}</div><div class="ss ${edgeDiff<0?'c-r':'c-d'}">${sgn}${edgeDiff} after</div></div>
    <div class="scard"><div class="sl">Density</div><div class="sv c-y">${(origStats.density||0).toFixed(4)}</div><div class="ss c-d">${(mitStats.density||0).toFixed(4)} after</div></div>
    <div class="scard"><div class="sl">Connected</div><div class="sv ${mitStats.is_connected?'c-g':'c-r'}">${origStats.is_connected?'YES':'NO'} → ${mitStats.is_connected?'YES':'NO'}</div></div>
  `;

  $('graphRow').style.display = 'grid';
  const oD = buildGD(scaledPos, origAdj);
  const pD = buildGD(scaledPos, mitAdj);
  G.O.nodes=oD.nodes; G.O.edges=oD.edges; G.O.cam={x:0,y:0,z:1}; G.O.cityR=cityR*50; G.O.cityName=city.name||'';
  G.P.nodes=pD.nodes; G.P.edges=pD.edges; G.P.cam={x:0,y:0,z:1}; G.P.cityR=cityR*50; G.P.cityName=city.name||'';
  initCv('O'); initCv('P');
  $('glbO').textContent = `${oD.nodes.length} nodes · ${oD.edges.length} edges`;
  $('glbP').textContent = `${pD.nodes.length} nodes · ${pD.edges.length} edges`;

  for(const k of['O','P']){
    const g=G[k]; if(!g.nodes.length) continue;
    let mnx=1e9,mny=1e9,mxx=-1e9,mxy=-1e9;
    for(const n of g.nodes){mnx=Math.min(mnx,n.x);mny=Math.min(mny,n.y);mxx=Math.max(mxx,n.x);mxy=Math.max(mxy,n.y);}
    const cv=$('cv'+k);
    g.cam.x=(mnx+mxx)/2; g.cam.y=(mny+mxy)/2;
    g.cam.z=Math.min(cv.width/((mxx-mnx||1)*1.25), cv.height/((mxy-mny||1)*1.25));
    g.cam.z=Math.max(0.1,Math.min(g.cam.z,3));
    rdr(k);
  }

  const lb=$('legendBar'); lb.classList.add('on');
  let lh='<span class="leg-title">Nodes</span>';
  for(const[t,cl] of Object.entries(NC)) lh+=`<span class="leg-item"><span class="ld" style="background:${cl}"></span>${t}</span>`;
  lh+='<span style="width:1px;height:16px;background:var(--border);margin:0 6px"></span><span class="leg-title">Edges</span>';
  for(const[t,cfg] of Object.entries(EC)) lh+=`<span class="leg-item"><span class="le" style="border-color:${cfg.c};border-style:${cfg.d.length?'dashed':'solid'}"></span>${EL[t]||t}</span>`;
  lb.innerHTML=lh;

  $('tabRow').classList.add('on');

  // Adjacency tab
  $('tab-adj').innerHTML = `<div class="adj-grid"><div class="adj-col" id="aO"></div><div class="adj-col" id="aP"></div></div>`;
  rAdjCol('aO','Original Network', origAdj, 'var(--blue)');
  rAdjCol('aP','Mitigated Network', mitAdj, 'var(--green)');

  // Changes tab
  rChg(changes);

  // LLM Reasoning tab
  const reasoning = d.groq_analysis?.reasoning || 'No LLM reasoning available.';
  $('tab-rea').innerHTML = `<div style="padding:20px;background:var(--bg-1);border:1px solid var(--border);border-radius:8px;font-size:13px;line-height:1.8;color:var(--text-1);white-space:pre-wrap;">${esc(reasoning)}</div>`;

  // JSON tab
  $('tab-jsn').innerHTML = `<pre style="padding:14px;background:var(--bg-1);border:1px solid var(--border);border-radius:7px;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--text-1);white-space:pre-wrap;word-break:break-all;max-height:600px;overflow:auto;line-height:1.6;">${esc(JSON.stringify(d,null,2))}</pre>`;
}

function rAdjCol(id, title, adj, dotColor){
  const el = $(id);
  if(!adj || !Object.keys(adj).length){
    el.innerHTML = `<h3>${title}</h3><div style="color:var(--text-2);padding:20px;text-align:center;font-size:12px;">No adjacency data</div>`;
    return;
  }
  let h = `<h3><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:${dotColor}"></span>${title}</h3><input class="adj-search" placeholder="Search nodes..." oninput="fAdj(this)">`;
  for(const[label,nbs] of Object.entries(adj).sort((a,b)=>a[0].localeCompare(b[0]))){
    const col = nC(label);
    h += `<div class="anode" data-label="${label.toLowerCase()}"><div class="anode-h" onclick="this.parentElement.classList.toggle('open')"><span class="nd" style="background:${col}"></span><span class="nn">${esc(label)}</span><span class="nc">${nbs.length}</span><span class="chev">▶</span></div><div class="anb">`;
    for(const n of nbs){
      h += `<div class="anb-r"><span class="rnd" style="background:${nC(n.neighbor)}"></span>${esc(n.neighbor)}<span class="retype et-${n.edge_type}">${n.edge_type}</span><span class="rdist">${n.distance.toFixed(1)}</span></div>`;
    }
    h += `</div></div>`;
  }
  el.innerHTML = h;
}

function fAdj(inp){
  const q = inp.value.toLowerCase();
  inp.parentElement.querySelectorAll('.anode').forEach(b => {
    b.style.display = b.dataset.label.includes(q) ? '' : 'none';
  });
}

function rChg(changes){
  if(!changes.length){
    $('tab-chg').innerHTML = '<div style="color:var(--text-2);padding:40px;text-align:center;">No changes applied</div>';
    return;
  }
  let h = '<div class="changes-list">';
  for(const c of changes){
    const phase = c.phase || 'unknown';
    const action = c.action || '';
    const phaseColor = phase === 'programmatic_pruning' ? 'var(--orange)' : phase === 'llm_optimization' ? 'var(--green)' : 'var(--red)';
    const phaseDim = phase === 'programmatic_pruning' ? 'var(--orange-dim)' : phase === 'llm_optimization' ? 'var(--green-dim)' : 'var(--red-dim)';

    h += `<div class="ccard phase-${phase}">`;
    h += `<div class="cr"><span class="ct" style="background:${phaseDim};color:${phaseColor}">${phase}</span> ${esc(action)}</div>`;

    if(c.from) h += `<div class="cm">${esc(c.from)} → ${esc(c.to||'')}</div>`;
    if(c.edge_type) h += `<div class="cm">Edge type: <code>${esc(c.edge_type)}</code></div>`;
    if(c.label) h += `<div class="cm">Node: ${esc(c.label)}</div>`;
    if(c.type) h += `<div class="cm">Type: ${esc(c.type)}</div>`;
    if(c.connected_to) h += `<div class="cm">Connected to: ${c.connected_to.map(esc).join(', ')}</div>`;
    if(c.via) h += `<div class="cm">Via: ${esc(c.via)}</div>`;
    if(c.reason) h += `<div class="cm" style="color:var(--text-2)">${esc(c.reason)}</div>`;

    h += `</div>`;
  }
  h += '</div>';
  $('tab-chg').innerHTML = h;
}

function sTab(id,btn){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-body').forEach(b=>b.classList.remove('active'));
  $('tab-'+id).classList.add('active');
}

/* ═══════════════════════════════════════════════════════════
   RUN PIPELINE (if no analysis exists)
   ═══════════════════════════════════════════════════════════ */
async function runPipeline(){
  const btn = $('runPipelineBtn');
  btn.disabled = true;
  btn.textContent = 'Running pipeline...';
  sS('loading', 'Running pipeline...');
  $('loadBar').classList.add('on');

  try {
    const r = await fetch('/run_pipeline', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ city: 'Boston' }),
    });
    if(!r.ok){
      const e = await r.json().catch(() => ({}));
      throw new Error(e.detail || `HTTP ${r.status}`);
    }
    toast('ok', 'Pipeline Complete', 'Analysis generated. Now running mitigation...');
    // Now fetch mitigation data
    await fetchMitigation();
  } catch(e) {
    sS('error', 'Pipeline failed');
    toast('error', 'Pipeline Error', e.message, 10000);
    btn.disabled = false;
    btn.textContent = 'Retry Pipeline for Boston';
  } finally {
    $('loadBar').classList.remove('on');
  }
}

/* ═══════════════════════════════════════════════════════════
   FETCH MITIGATION DATA
   ═══════════════════════════════════════════════════════════ */
async function fetchMitigation(){
  sS('loading', 'Running mitigation engine...');
  $('loadBar').classList.add('on');

  try {
    const r = await fetch('/mitigate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    });

    if(!r.ok){
      const e = await r.json().catch(() => ({}));
      if(r.status === 400 && e.detail && e.detail.includes('apocalypse_analysis.json')){
        // No analysis file — show empty state
        sS('error', 'No analysis data');
        $('emptyState').style.display = 'flex';
        toast('warn', 'No Analysis Found', 'Run the pipeline first to generate threat analysis.', 8000);
        return;
      }
      throw new Error(e.detail || `HTTP ${r.status}`);
    }

    const data = await r.json();
    sS('ok', `${data.city?.name || 'Unknown'} — ${data.data_source}`);
    toast('ok', 'Mitigation Complete', `${data.original_stats?.infrastructure_nodes || '?'} infrastructure nodes analyzed via ${data.data_source}`);
    renderAll(data);

  } catch(e) {
    sS('error', 'Failed');
    if(e.message.includes('Failed to fetch') || e.message.includes('NetworkError')){
      toast('error', 'Backend Unavailable', 'Cannot reach the backend. Start it with: uvicorn Backend:app --port 8000', 12000);
      $('emptyState').querySelector('.es-desc').textContent = 'The FastAPI backend is not running. Start it with: uvicorn Backend:app --port 8000';
      $('emptyState').querySelector('.es-btn').style.display = 'none';
      $('emptyState').style.display = 'flex';
    } else {
      toast('error', 'Error', e.message, 8000);
    }
  } finally {
    $('loadBar').classList.remove('on');
  }
}

/* ═══════════════════════════════════════════════════════════
   INIT: Check backend health, then fetch mitigation
   ═══════════════════════════════════════════════════════════ */
async function init(){
  try {
    const h = await fetch('/health');
    if(h.ok){
      const hd = await h.json();
      if(hd.analysis_ready){
        // Analysis exists, go straight to mitigation
        await fetchMitigation();
      } else {
        // Backend is up but no analysis yet
        sS('error', 'No analysis data');
        $('emptyState').style.display = 'flex';
      }
    } else {
      throw new Error('Backend not reachable');
    }
  } catch(e) {
    // Backend not running — show empty state with connection error
    sS('error', 'Backend offline');
    $('emptyState').querySelector('.es-title').textContent = 'Backend Not Running';
    $('emptyState').querySelector('.es-desc').textContent =
      'Start the FastAPI backend to use the mitigation engine:\n\nuvicorn Backend:app --port 8000';
    $('emptyState').querySelector('.es-btn').style.display = 'none';
    $('emptyState').style.display = 'flex';
  }
}

init();
</script>
</body>
</html>
